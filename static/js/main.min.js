app=angular.module("airdate",[]).controller("mainController",["$scope","$http","$location",function(s,e,o){function n(o){e.get("http://api.tvmaze.com/shows/"+o.id+"/episodes?").success(function(e){for(i=0;i<e.length;i++){var n={},a=new Date(e[i].airstamp),r=new Date,p=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],c=new Date(+r-864e5*s.userDays);n.show=o.name,n.showId=o.id,n.airdate=p[a.getMonth()]+" "+a.getDate()+", "+a.getFullYear(),n.airtime=a.toTimeString().substring(0,5),n.airstamp=e[i].airstamp,n.name=e[i].name,n.season=e[i].season,n.runtime=e[i].runtime,n.summary=e[i].summary.substring(3,e[i].summary.length-4),n.watched=!1,e[i].number<10?n.epInSeason="0"+e[i].number:n.epInSeason=e[i].number,a>r?(o.upcomingEpisodes.push(n),s.watchlist.push(n)):r>a&&a>c?(s.recentEpisodes.push(n),o.pastEpisodes.push(n)):o.pastEpisodes.push(n),n=""}return t(o),o}).error(function(s){console.log(s)})}function t(s){if(s.upcomingEpisodes.length>0)var e=s.upcomingEpisodes[s.upcomingEpisodes.length-1];else var e=s.pastEpisodes[s.pastEpisodes.length-1];var o=e.season;for(j=0;j<o;j++)s.seasons.push([]);for(p=0;p<s.pastEpisodes.length;p++)for(i=0;o>=i;i++)s.pastEpisodes[p].season==i+1&&s.seasons[i].push(s.pastEpisodes[p]);return s}s.searchResults=[],s.userShows=[],s.watchlist=[],s.recentEpisodes=[],s.searching=!1,s.selectedSeason=-1,s.userDays=14,popularShows=["143","618","32"],s.popShows=[],s.toggle=!1,s.showLogin=!1,s.showSignup=!1,s.popupText="",s.showWatchlist=!0,s.showLogin?s.showSignup=!1:s.showSignup&&(s.showLogin=!1),o.search().login?s.showLogin=!0:o.search().signup&&(s.showSignup=!0);for(var i=0;i<popularShows.length;i++)e.get("http://api.tvmaze.com/shows/"+popularShows[i]).success(function(e){var o={};o.name=e.name,o.id=e.id,o.network=e.network.name,o.premiered=e.premiered,o.art=e.image.original,console.log(o),s.popShows.push(o)}).error(function(s){console.log(s)});e.get("/api/shows").success(function(e){for(var o=0;o<e.length;o++){var t=e[o];t.upcomingEpisodes=[],t.pastEpisodes=[],t.seasons=[],n(t),s.userShows.push(t)}}).error(function(s){console.log(s)}),s.search=function(){s.searching=!0,e.get("http://api.tvmaze.com/search/shows?q="+s.searchTerm).success(function(e){s.searching=!1,s.searchResults=e}).error(function(e){s.searching=!1})},s.select=function(o,t,i){s.searching=!0,s.searchTerm="";var a={};a.upcomingEpisodes=[],a.pastEpisodes=[],a.seasons=[],a.name=o,a.id=t,a.started=i.substring(0,4),n(a),s.userShows.push(a),e.post("/addShow",{show:a}),localStorage.setItem("userShowID",a.id),a=""},s.deleteShow=function(o){var n=s.userShows.indexOf(o);if(n>-1){s.userShows.splice(n,1),e.post("/rmShow",{showId:o.id});for(var t=0;t<s.watchlist.length;t++)s.watchlist[t].showId==o.id&&(s.watchlist.splice(t,1),t--);for(var t=0;t<s.recentEpisodes.length;t++)s.recentEpisodes[t].showId==o.id&&(s.recentEpisodes.splice(t,1),t--)}},s.deleteAccount=function(){e.post("/user/delete")},s.selectSeason=function(e){s.selectedSeason=e}}]).directive("toggleClass",function(){return{restrict:"A",link:function(s,e,o){e.bind("click",function(){e.toggleClass(o.toggleClass)})}}});